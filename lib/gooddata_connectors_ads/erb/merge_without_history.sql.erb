MERGE INTO <%= input["schema"] %>.<%= input["table_name"] %> o
USING <%= input["schema"] %>.<%= input["temp_table_name"] %> temp
ON (
    o.<%= input["id"] %> = temp.<%= input["id"] %>
)
WHEN MATCHED THEN
    UPDATE SET
        <% input["fields"].each do |field| %>
            <%= field %> = temp.<%= field %>,
        <%end%>
        _load_at = '<%= input["load_at"]%>',
        _load_id = <%= input["load_id"]%>,
        <% if (input.include?("timestamp")) %>
            <%= input["timestamp"]%> = temp.<%= input["timestamp"]%>,
        <% end %>
        <% if (input.include?("computed_fields") and !input["computed_fields"].empty?) %>
            <% input["computed_fields"].each do |value| %>
                <%= value["target"] %> = temp.<%= value["source"] %>,
            <%end%>
        <% end %>
        _is_deleted = false
WHEN NOT MATCHED THEN INSERT
    (
        <%= input["id"] %>,<%= input["fields"].join(", ") %>,
        <%= input.include?("timestamp") ? "#{input["timestamp"]}," : "" %>
        <% if (input.include?("computed_fields") and !input["computed_fields"].empty?) %>
            <% input["computed_fields"].each do |value| %>
                <%= value["target"] %>,
            <%end%>
        <% end %>
        _load_at,_load_id,_is_deleted
        )
VALUES (
        temp.<%= input["id"] %>,
        <% input["fields"].each do |field| %>temp.<%= field %>,<%end%>
        <%= input.include?("timestamp") ? "temp.#{input["timestamp"]}," : "" %>
        <% if (input.include?("computed_fields") and !input["computed_fields"].empty?) %>
            <% input["computed_fields"].each do |value| %>
                temp.<%= value["source"] %>,
            <%end%>
        <% end %>
        '<%= input["load_at"]%>',<%= input["load_id"]%>,false
        );