INSERT INTO <%= input["schema"] %>.<%= input["stage_table_name"] %> (<%= input["id"]%>,<%= input["fields"].map{|v| v["name"] }.join(',')%>,<%= input["metadata_fields"].join(',')%>)
SELECT
    <%= input["id"]%>,
    <% input["fields"].each_with_index do |field,index| %>
        <%= "CAST(#{field["name"]} as #{TypeConverter.to_database_type(field["type"])}" %>,
    <%end%>



    <%= input["history_timestamp"]%> as <%= input["metadata_timestamp"]%>,
    <%= input["load_id"]%>,
    '<%= input["load_at"]%>'
FROM
(
<% input["fields"].each_with_index do |field,index| %>
    SELECT
        <%= input["history_id"]%> as <%= input["id"]%>,
        <% input["fields"].each do |inner_field| %>
            <% if inner_field["type_object"].nullabble? %>
                <%= inner_field["name"] == field["name"] ? "CASE WHEN value = '' THEN NULL ELSE value END as #{inner_field["name"]}" : "NULL as #{inner_field["name"]}" %>,
            <% else %>
                <%= inner_field["name"] == field["name"] ? "value as #{inner_field["name"]}" : "NULL as #{inner_field["name"]}" %>,
            <%end%>
        <%end%>
        <%= input["history_timestamp"]%>
    FROM <%= input["schema"] %>.<%= input["table_name"] %>
    WHERE key = '<%= field["name"] %>'

    <% if (index != input["fields"].count - 1) %>UNION ALL<%end%>
<%end%>
) inner_union;
